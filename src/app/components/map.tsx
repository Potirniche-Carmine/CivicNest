"use client"

import React, { useEffect, useRef } from "react";
import mapboxgl from 'mapbox-gl';
import { useTheme } from "next-themes";

mapboxgl.accessToken = 'pk.eyJ1IjoidG5vcnJpczU1IiwiYSI6ImNtNWxpdjVrOTB4b3gyam9xNGJpbml3YnQifQ.xAv-Vz7lcSjlya4TuFScYA';

export function Map() {
    const mapRef = useRef<HTMLDivElement>(null);
    const mapInstanceRef = useRef<mapboxgl.Map | null>(null);
    const { theme, systemTheme } = useTheme();

    const isDarkMode = theme === "system" 
        ? systemTheme === "dark"
        : theme === "dark";

    const polygons: GeoJSON.FeatureCollection<GeoJSON.Polygon> = {
        type: "FeatureCollection",
        features: [
            {
                type: "Feature",
                properties: { 
                    id: 1, 
                    color: isDarkMode ? "#4a9eff" : "#2b6cb0"
                },
                geometry: {
                    type: "Polygon",
                    coordinates: [
                        [
                            [-119.858883, 39.512475],  
                            [-119.856763, 39.512631],  
                            [-119.851716, 39.514111],  
                            [-119.850298, 39.515931],  
                            [-119.848867, 39.518351],  
                            [-119.846009, 39.519976],  
                            [-119.834961, 39.524137],  
                            [-119.830844, 39.525441],  
                            [-119.828201, 39.525975],  
                            [-119.826750, 39.526761],  
                            [-119.826447, 39.526426],  
                            [-119.825039, 39.522065],  
                            [-119.824540, 39.520377],  
                            [-119.824540, 39.520043],  
                            [-119.824952, 39.519207],  
                            [-119.825104, 39.518088],  
                            [-119.825702, 39.515917],  
                            [-119.830327, 39.513025],  
                            [-119.832080, 39.512687],  
                            [-119.835828, 39.509908],  
                            [-119.837760, 39.509670],  
                            [-119.840632, 39.508793],  
                            [-119.844673, 39.507191],  
                            [-119.846409, 39.506790],  
                            [-119.848032, 39.505923],  
                            [-119.851010, 39.505312],  
                            [-119.853218, 39.505617],  
                            [-119.858445, 39.507529],  
                            [-119.858487, 39.510695],  
                            [-119.858883, 39.512475],

                        ],
                    ],
                },
            },
            {
                type: "Feature",
                properties: { 
                    id: 2, 
                    color: isDarkMode ? "#48bb78" : "#2f855a"
                },
                geometry: {
                    type: "Polygon",
                    coordinates: [
                        [
                            [-119.862108, 39.523864],  
                            [-119.858053, 39.525579],  
                            [-119.853998, 39.526185],  
                            [-119.836142, 39.526941],  
                            [-119.830452, 39.528909],  
                            [-119.828490, 39.530170],  
                            [-119.823715, 39.531633],  
                            [-119.819006, 39.533600],  
                            [-119.815932, 39.534205],  
                            [-119.814385, 39.529985],  
                            [-119.825395, 39.527843],  
                            [-119.827937, 39.526275],  
                            [-119.835278, 39.524291],  
                            [-119.847818, 39.519552],  
                            [-119.849175, 39.518531],  
                            [-119.849804, 39.517871],  
                            [-119.851025, 39.515531],  
                            [-119.852699, 39.514344],  
                            [-119.857115, 39.513089],  
                            [-119.859123, 39.512795],  
                            [-119.862108, 39.523864],
                        ],
                    ],
                },
            },
            {
                type: "Feature",
                properties: { 
                    id: 3, 
                    color: isDarkMode ? "#48bb78" : "#2f855a"
                },
                geometry: {
                    type: "Polygon",
                    coordinates: [
                        [
                            [-119.824711, 39.550622],  
                            [-119.823824, 39.549111],  
                            [-119.822939, 39.547678],  
                            [-119.822056, 39.546323],  
                            [-119.821175, 39.545044],  
                            [-119.820298, 39.543839],  
                            [-119.819424, 39.542706],  
                            [-119.818555, 39.541646],  
                            [-119.817690, 39.540655],  
                            [-119.816831, 39.539732],  
                            [-119.815977, 39.538877],  
                            [-119.815129, 39.538087],  
                            [-119.814289, 39.537361],  
                            [-119.813455, 39.536697],  
                            [-119.812629, 39.536094],  
                            [-119.811812, 39.535551],  
                            [-119.811003, 39.535065],  
                            [-119.810203, 39.534636],  
                            [-119.809414, 39.534262],  
                            [-119.808634, 39.533942],  
                            [-119.807866, 39.533673],  
                            [-119.807108, 39.533455],  
                            [-119.806363, 39.533286],  
                            [-119.805629, 39.533164],  
                            [-119.804909, 39.533089],  
                            [-119.804202, 39.533058],  
                            [-119.803509, 39.533070],  
                            [-119.802830, 39.533123],  
                            [-119.802166, 39.533217],  
                            [-119.801517, 39.533349],  
                            [-119.800884, 39.533518],  
                            [-119.800268, 39.533723],  
                            [-119.799668, 39.533962],  
                            [-119.799086, 39.534233],  
                            [-119.798522, 39.534535],  
                            [-119.797976, 39.534867],  
                            [-119.797449, 39.535228],  
                            [-119.796942, 39.535614],  
                            [-119.796454, 39.536026],  
                            [-119.795987, 39.536462],  
                            [-119.795541, 39.536919],  
                            [-119.795116, 39.537397],  
                            [-119.794713, 39.537895],  
                            [-119.794333, 39.538410],  
                            [-119.793975, 39.538941],  
                            [-119.793642, 39.539487],  
                            [-119.793332, 39.540046],  
                            [-119.793046, 39.540617],  
                            [-119.792786, 39.541198],  
                            [-119.792551, 39.541787],  
                            [-119.792342, 39.542384],  
                            [-119.792160, 39.542986],  
                            [-119.792004, 39.543593],  
                            [-119.791877, 39.544203],  
                            [-119.791777, 39.544813],  
                            [-119.791706, 39.545424],  
                            [-119.791664, 39.546032],  
                            [-119.791651, 39.546638],  
                            [-119.791669, 39.547238],  
                            [-119.791717, 39.547833],  
                            [-119.791796, 39.548420],  
                            [-119.791907, 39.548997],  
                            [-119.792050, 39.549564],  
                            [-119.792225, 39.550119],  
                            [-119.792434, 39.550659],  
                            [-119.792676, 39.551185],  
                            [-119.792952, 39.551694],  
                            [-119.793263, 39.552185],  
                            [-119.793609, 39.552656],  
                            [-119.793991, 39.553106],  
                            [-119.794409, 39.553534],  
                            [-119.794864, 39.553937],  
                            [-119.795356, 39.554314],  
                            [-119.795885, 39.554665],  
                            [-119.796453, 39.554987],  
                            [-119.797060, 39.555278],  
                            [-119.797705, 39.555539],  
                            [-119.798391, 39.555766],  
                            [-119.799116, 39.555958],  
                            [-119.799882, 39.556114],  
                            [-119.800690, 39.556233],  
                            [-119.801539, 39.556313],  
                            [-119.802431, 39.556352],  
                            [-119.803365, 39.556349],  
                            [-119.804343, 39.556303],  
                            [-119.805364, 39.556211],  
                            [-119.806430, 39.556073],  
                            [-119.807540, 39.555887],  
                            [-119.808696, 39.555652],  
                            [-119.809897, 39.555365],  
                            [-119.811145, 39.555026],  
                            [-119.812440, 39.554633],  
                            [-119.813782, 39.554184],  
                            [-119.815172, 39.553679],  
                            [-119.816610, 39.553115],  
                            [-119.818097, 39.552491],  
                            [-119.819633, 39.551805],  
                            [-119.821219, 39.551057],  
                            [-119.822856, 39.550244],  
                            [-119.824544, 39.549365],
                        ],
                    ],
                },
            },
        ],
    };

    useEffect(() => {
        if (!mapRef.current) return;

        const initializeMap = () => {
            if (!mapInstanceRef.current) {
                mapInstanceRef.current = new mapboxgl.Map({
                    container: mapRef.current as HTMLElement,
                    style: isDarkMode
                        ? "mapbox://styles/mapbox/dark-v11"
                        : "mapbox://styles/mapbox/light-v11",
                    center: [-119.816326, 39.543627],
                    zoom: 15,
                });

                mapInstanceRef.current.on('load', () => {
                    if (!mapInstanceRef.current) return;

                    mapInstanceRef.current.addSource('polygons', {
                        type: 'geojson',
                        data: polygons,
                    });

                    mapInstanceRef.current.addLayer({
                        id: 'polygons-layer',
                        type: 'fill',
                        source: 'polygons',
                        paint: {
                            'fill-color': ['get', 'color'],
                            'fill-opacity': isDarkMode ? 0.6 : 0.5, // Slightly higher opacity for dark mode
                        },
                    });
                });
            } else {
                mapInstanceRef.current.setStyle(
                    isDarkMode
                        ? "mapbox://styles/mapbox/dark-v11"
                        : "mapbox://styles/mapbox/light-v11"
                );

                mapInstanceRef.current.once('style.load', () => {
                    if (!mapInstanceRef.current) return;

                    if (!mapInstanceRef.current.getSource('polygons')) {
                        mapInstanceRef.current.addSource('polygons', {
                            type: 'geojson',
                            data: polygons,
                        });

                        mapInstanceRef.current.addLayer({
                            id: 'polygons-layer',
                            type: 'fill',
                            source: 'polygons',
                            paint: {
                                'fill-color': ['get', 'color'],
                                'fill-opacity': isDarkMode ? 0.6 : 0.5,
                            },
                        });
                    } else {
                        (mapInstanceRef.current.getSource('polygons') as mapboxgl.GeoJSONSource)
                            .setData(polygons);
                    }
                });
            }
        };

        initializeMap();

        return () => {
            mapInstanceRef.current?.remove();
            mapInstanceRef.current = null;
        };
    }, [isDarkMode]);

    return (
        <div className="w-full h-[700px] rounded-lg overflow-hidden border border-border" ref={mapRef} />
    );
}
